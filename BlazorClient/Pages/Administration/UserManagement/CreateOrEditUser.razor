@page "/UserManagement/CreateOrEditUser"
@using Security.Core.Models.Administration.RoleManagement
@using Security.Core.Models.Authentication

<h3>User Details: @_selectedUser.Email</h3>
<hr />

<table class="table-sm table-bordered w-100">
    <thead>
        <tr><th colspan="6"><span class="h2">Trusted Devices</span></th></tr>
        <tr>
            <th>Device Id</th>
            <th>Name</th>
            <th>Created</th>
            <th>Expires On</th>
            <th>Valid</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (RefreshTokenDto refreshToken in _selectedUser.RefreshTokens)
        {
            <tr class="border-bottom">
                <td>(@refreshToken.UserId) @refreshToken.DeviceId</td>
                <td>@refreshToken.DeviceName</td>
                <td>@refreshToken.Created</td>
                <td>@refreshToken.Expiry</td>
                <td>
                  <i class="@GetValidStatusIcon(refreshToken)"></i>
                </td>
                <td><button class="btn btn-danger" @onclick="(() => RevokeRefreshToken(refreshToken))">Revoke</button></td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr>
            <td colspan="6"><button class="btn btn-info justify-content-end" @onclick="(() => RevokeAllTokens())">Log Out All Devices</button></td>
        </tr>
    </tfoot>
</table>


<table class="table-sm">
    <thead>
        <tr><th colspan="2">User Access</th></tr>
        <tr>
            <th>
                Email Address
            </th>
            <th>
                Permissions
            </th>
        </tr>
    </thead>
    <tbody id="permission-selection">
        <tr>
            <td valign="top">@_selectedUser.Email</td>
            <td colspan="2">
                <table class="table-sm">
                    <thead>
                        <tr>
                            <th colspan="4">Assigned Roles</th>
                        </tr>
                        <tr>
                            <th>
                                Name
                            </th>
                            <th>
                                Description
                            </th>
                            <th>
                                Permissions
                            </th>
                            <th>
                                Assigned
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (RoleDto role in _roleList)
                        {
                            <tr class="border-bottom">
                                <td>@role.Name</td>
                                <td>@role.Description</td>
                                <td>
                                    @foreach (var permission in role.PermissionsInRole)
                                    {
                                        <li>@permission</li>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (_selectedUser.AssignedRoles.Any(ar => ar.RoleName == role.Name && !ar.IsDeleted))
                                    {
                                        <button class="btn btn-danger" @onclick="(() => RevokeRole(role))">Revoke</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success" @onclick="(() => GrantRole(role))">Grant</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button class="btn btn-info" @onclick="(() => SaveAsync())">Save</button>
                @if (_messages != null && _messages.Count() > 0)
                {
                    foreach (string message in _messages)
                    {
                        <ul>
                            <li>@message</li>
                        </ul>
                    }
                }
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2">
            </td>
        </tr>
    </tfoot>
</table>

@*<tr>
    <td>
    @permission.GroupName
    </td>
    <td>
    @permission.Description
    </td>
    <td>
    @permission.PermissionName

    </td>
    <td>
    <button type="button" class="btn-sm  @(Model.PermissionsWithSelect[i].Selected ? "btn-primary" : "btn-secondary")">
    @(Model.PermissionsWithSelect[i].Selected ? "Selected" : "Select")
    </button>
    </td>
    </tr>*@